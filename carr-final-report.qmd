---
title: "STAT 341 Final Report"
author: "Levi carr"
format: pdf
---
```{r, include=FALSE}
cirrus_fit_w_mixed_phase <- readRDS("cirrus_fit_3.RDS")
cirrus_fit_wo_mixed_phase <- readRDS("cirrus_fit_no_mixed_phase.RDS")
```
### Research Question
In cirrus clouds, how does the effective radius of the droplets change with ice composition? 

### Causal Diagram
Draw it, and interpret it to determine which predictors are in and out of your model! May be drawn in R using dagitty(), or in other software if moderators are included

### The PACE Mission and the Cloud Dataset
#### Mission Overview
PACE (Plankton, Aerosol, Cloud, ocean Ecosystem) is a NASA science mission launched into on 08-Feb 2024 to extend and improve observations of global ocean biology, aerosols, and clouds. PACE has three science instruments aboard to examine the earth from above: the SPEXone polarimeter, the HARP2 polarimeter, and the Ocean Color Instrument (OCI). From NASA: "PACE's primary sensor, the Ocean Color Instrument (OCI), is a highly advanced optical spectrometer that measures properties of light over portions of the electromagnetic spectrum. It enables continuous measurement of light at finer wavelength resolution than previous NASA satellite sensors, extending key system ocean color data records for climate studies." This instrument yields atmospheric data products that I use for my analysis of cirrus cloud effective radii.

The satellite's orbital period is one solar day, so data is naturally binned by day. From the data, I selected a "training" day (where I looked directly at the data) and a "test" day which I fit the model to. These days were March 30th and April 2nd, respectively. The data files used are given in the "Data Availability" section.

#### Selecting Cirrus Clouds
From the cloud data products we also have variables such as the optical thickness $\tau$ (a measure of transmission) and cloud top pressure $T_{top}$. Heymsfield et al. (2017) state that cirrus clouds are observed to have cloud top temperatures greater than $-40^{\circ}$ C and optical thicknesses less than 3.1. Thus, I select only values from the cloud data set for $T_{top} > 233.15$ K and $\tau <3.1$. 

### Making Categorical Predictors
I have a post processing variable from the data set called `cf_ice` which describes how much of the cloud is ice. `cf_ice` ranges from 0 to 1 where 0 is an all liquid water cloud and 1 is an all ice cloud. By looking at the distribution of `cf_ice` on other days, a pattern of two high density peaks around 0 and 1 with a few cases in between is predominant. I therefore separate the data into three groups: "no ice" (0.05 > `cf_ice`), "some ice" (0.05 < `cf_ice` < 0.95), and "all ice" (`cf_ice` > 0.95).

### Model Description 
 $$
 R_{eff} \sim \mathrm{Gamma}(\mu_i, \sigma)
 $$
The effective radius ($R_eff$) of droplets in clouds has been identified in the literature as one that is described by a gamma process (Hansen 1971). This likelihood distribution is used in almost all droplet size distribution models.
 
 $$
 \ln(\mu_i) = \beta_0 + \beta_1 \left[ \text{ice fraction}_i \right]
 $$
 Since $\ln{\mu}$ is a linear relationship, we can say that $R_{eff}$ is a GLM. Since $R_{eff}$ is modeled as a gamma GLM, we use a logarithmic link function to assure that all inputs to the likelihood distribution are strictly positive. In particular, $\ln(\mu)$ is a function of $\beta_0$ and $\beta_1 \left[ \text{ice fraction} \right]$. $\beta_0$ is as the global average $R_{eff}$ for all cloud types. $\beta_1$ is a 3-vector with one component for each cirrus subset (no ice, some ice, and all ice). The components of $\beta_1$ are then the corrections from the global average $R_{eff}$ value for each phase type. 
 $$
 \beta_0 \sim \mathrm{Normal}(\ln(20), \ln(e))
 $$
 
It is very hard to track down the size of liquid water in cirrus clouds, so I hypothesize that the radius of liquid water droplets are smaller in clouds to the merit that liquid water expands when it freezes, often into shapes that are not minimal surfaces; this is to say that ice's effective radius should be larger. Since $\beta_0$ is the global average which includes the ice clouds, my hypothesis suggests that the radii are smaller than the average effective radius of cirrus clouds.

Assume that the hypothesis is true and that all ice and no ice clouds are found in equal proportions across the globe. It should be the case then that the global average is the average of the means of the all ice and no ice cloud droplet distributions. Since water expands by ~10%, the mean effective radius for no ice clouds should be smaller than the global average by ~5% or ~1$\mu m$. Likewise, the mean effective radius for all ice clouds should be ~5% larger than the global average, or ~1$\mu m$. How do we get this to work with the link function? Start by writing

$$
\ln(\vec{\mu_j}) = \vec{\beta}_0 + \vec{\beta}_{1,j}
$$
where $j = 1,2,3$ are the no ice, some ice, and all ice populations, respectively, represented as components of $\vec{\beta}_1$. 

$$
\vec{\mu_j} = e^{\vec{\beta}_0 + \vec{\beta}_{1,j}} = e^{\vec{\beta}_0} e^{\vec{\beta}_{1,j}} = e^{\vec{\beta}_0} \left[ e^{\beta_{1,1}}, e^{\beta_{1,2}}, e^{\beta_{1,3}} \right]^\top
$$
But $e^{\vec{\beta}_0}$ is just the global average $R_{eff}$ and $\vec{\mu}$ is a vector of our expected values for each phase of matter. So $e^{\vec{\beta}_0} = [20, 20, 20]^\top$, $\mu = [19, 20, 21]$, and  

$$
\vec{\mu}\cdot e^{-\vec{\beta}_0} = \frac{1}{20}[19, 20, 21]^\top = \left[ e^{\beta_{1,1}}, e^{\beta_{1,2}}, e^{\beta_{1,3}} \right]^\top = e^{\vec{\beta}_{1,j}}
$$
therefore, the prior means, $\vec{\beta}_{1,j}$, are

$$
\vec{\beta}_{1,j} = \ln{\left( \frac{1}{20}[19, 20, 21]^\top \right)} = [-0.05129, 0.0, 0.04879]^\top
$$

As a result, I suppose

$$
 \beta_1[\text{no ice}] \sim \mathrm{Student}(\nu = 2, \;\text{mean}= -0.05129, \;\text{sigma}= -0.1)
$$
I could not track down a value for the variance of the liquid phase's effective radius, but I expect it to be fairly exact since it is based on a physical basis. I chose a (natural log) standard deviation of -0.1 (standard deviation 0.9048 $\mu m$). Even so, I regularize the prior with a student t-distribution so that the data may still drive the posterior.
 
 $$
 \beta_1[\text{some ice}] \sim \mathrm{Student}(\nu = 2, \;\text{mean}= 0.00000, \;\text{sigma}= 0.2)
 $$
 
 There are a small number of mixed-phase cirrus clouds, but they range from 5-95% ice by my artificial distinction. I expect the average radii of droplets in these clouds to be close to the global average, but with a larger variation than their ice and liquid counterparts given the wide range of possible phase concentrations. A standard deviation of 0.4 was chosen via the prior predictive distribution.
 
 $$
 \beta_1[\text{all ice}] \sim \mathrm{Student}(\nu = 2, \;\text{mean}= -0.04879, \;\text{sigma}= -0.1)
 $$
 By my hypothesis, the freezing of liquid water droplets should yield larger effective radii, so the correction to the average should be positive. Like the liquid droplet case, I could not find much for variance information, but I still expect it to be fairly constrained since the cloud is composed only of one phase of matter. I chose a (natural log) standard deviation of -0.1 (standard deviation 0.9048 $\mu m$). Even so, I regularize the prior with a student t-distribution so that the data may still drive the posterior.
 
 
 By analyzing one day of data, I found that most effective radii were above 10 $\mu m$. Therefore, I adopt a lognormal distribution (strictly positive outputs, faster probability drop than an exponential) to describe the standard deviation in effective radius. Knowing that many of the $R_{eff}$ distributions have an effective lower bound at 10 and an effective upper bound ~80, I chose to adopt the following as my standard deviation:
 $$
 \sigma \sim \mathrm{Lognormal}(\ln(15), 0.5)
 $$
 

### Prior Predictive Distribution
Using the prior information above, I construct a prior predictive distribution for the effective radii in each population.

![The prior predictive distribution for each population of clouds, grouped by phase of matter. No ice is on the left, some ice is in the center, all ice is on the right.](prior_pred1.png)

As seen from the prior predictive distribution(s), the three populations are nearly identical. Furthermore, there may be an unaccounted for effect driving many of the effective radii towards zero. I do not have the theoretical background to know what physical mechanism this might be. 

![The first 20 prior predictive distributions for effective radius. Note that the distributions not with mean ~ 0 follow the expected/observed distribution for real cirrus clouds.](prior_pred2.png)


![Boxplots of the first 20 simulated values of $mu$ with respect to ice content. No ice is seen on the left, some ice in the center, and all ice on the right of each pane.](prior_pred3.png)


### Model 
This model was fit by the MCMC package cmdstan. Four chains were computed with 2000 total iterations each using `adapt_delta = 0.8`

#### Diagnostics for Fit Convergence 	
I analyzed two fits of convergence readily available in stan: neff and Rhat. This model uses 1000 sampling iterations. The neff for the parameters associated with the categorical predictors is ~500 for all, indicating that the sampling process was mildly inefficient. Rhat for all parameters associated with the predictors was 1.00. 
```{r}
cirrus_fit_w_mixed_phase
cirrus_fit_wo_mixed_phase
```

Additionally, I plot the MCMC trace for all four chains to check for visual convergence.
![The MCMC trace for the cirrus model that includes mixed phase clouds.](mcmc_trace_w_mixed_phase.png)
The chains are fairly well mixed, but not superb. Similarly, they appear to be mostly stationary. However, since the Rhat and neff values are within acceptable limits we choose to proceed.

#### Posterior
You may include any graphs or summary statistics of your choice that you think are useful in understanding the posterior.
I present the posteriors for the effective radius intercept and "correction" parameters. Because of the link function, the values are the natural log of the actual effective radius. 

![The effective radius intercept posterior. This should represent the global average of cirrus cloud droplet effective radius.](reff_intercept.png)
![The effective radius "no ice" correction posterior. This should represent the global average of cirrus cloud droplet effective radius.](reff_no-ice.png)
![The effective radius "some ice" correction posterior. This should represent the global average of cirrus cloud droplet effective radius.](reff_some-ice.png)
![The effective radius "all ice" correction posterior. This should represent the global average of cirrus cloud droplet effective radius.](reff_all-ice.png)

There are two trends that I did not expect in these posteriors. First, I did not expect the intercept to be as small as it is. When exponentiated, the mode of this distribution comes out to ~0.045 $\mu m$ which is much smaller than what I expected and what I saw in the March 30th dataset. While this could be an error in the stan fitting code, I could not find it in the time needed for this project. The second trend is seen in the difference of the correction parameters:

![The difference between the ln(effective radii) in "some ice" and "no ice" clouds. A natural log difference of -0.35 on this scale corresponds to a difference of ~0.7 $\mu m$. The posteriors above suggest that the negative value of the difference implies that the "no ice" populations tend to have droplets with larger effective radii than cirrus clouds of mixed phase.](reff_diff_some-no.png) 
![The difference between the ln(effective radii) in "some ice" and "no ice" clouds. A natural log difference of -0.375 on this scale corresponds to a difference of ~0.68 $\mu m$. The posteriors above suggest that the negative value of the difference implies that the "some ice" populations tend to have droplets with larger effective radii than cirrus clouds in the solid phase.](reff_diff_all-some.png) 
![The difference between the ln(effective radii) in "all ice" and "no ice" clouds. A natural log difference of -0.725 on this scale corresponds to a difference of ~0.48 $\mu m$. The posteriors above suggest that the negative value of the difference implies that the "no ice" populations tend to have droplets with larger effective radii than cirrus clouds of solid phase.](reff_diff_all-no.png) 
These results seem to indicate the opposite relationship between "all ice" cirrus clouds and "no ice" cirrus clouds than I expected. The droplets in "all ice" clouds are smaller on average than the droplets in "no ice" clouds. However, the ongoing issue with the value of the intercept might also be linked to the values of these corrections. If so, the corrections, like the intercept, should be viewed with great skepticism.

I want to make a posterior predictive distribution using the mu[i] values that were calculated in stan, but I am not sure how to do this. Any pointers would be greatly appreciated.

#### Model Comparison
Another model was fit with where the mixed phase clouds were divided between the "no ice" and "all ice" populations. This is a test to probe whether modeling the mixed phase clouds can be done with a simpler model since the mixed phase clouds are not common. In data prep, the `cf_ice` number was divided at 0.5; all observations with `cf_ice < 0.5` went to "no ice" and the remainder went to "all ice". A modification to the stan code was made to reflect the elimination of a prior, but no other features were changed. The model was analyzed for convergence as above and was found to be convergent. I use the WAIC function from the `Rethinking` package by Richard McElreath to compare the two models. The results are shown below.

```{R}
compare(cirrus_fit_w_mixed_phase, cirrus_fit_wo_mixed_phase, func=WAIC)
```

It is clear from the WAIC scores that the cirrus model that accounts for the mixed phase is significantly better at describing the data than the model that does not account for the mixed phase.

### Conclusion
According to the analysis done here, it appears that cirrus clouds made entirely of ice are composed of droplet with smaller effective radii than the global average, and cirrus clouds made entirely of water are composed of droplets with larger effective radii than the global average. This is a direct reversal of my hypothesis. However, prior knowledge of droplet size distributions for cirrus clouds suggests that the global average droplet effective radius (reported here as the $\beta_0$ parameter) is much greater than the value found in my analysis by about a factor of 1000. It is possible that there is a unit issue with effective radii being reported in mm instead of $\mu$m, and this should be looked into as the reported unit from the PACE database is "microns" (equivalently, $\mu$m).

### Data Availability
All my files are available upon request through GitHub. Files can be found at https://github.com/carr-levi-a/calvinbayes25_atmsci.

I used data from the NASA PACE mission accessed through https://oceandata.sci.gsfc.nasa.gov/directdataaccess/. In particular, I use Level 3 Mapped data product from the OCI instrument with a resolution of 0.1 deg or ~11 km. The dates were March 30th, 2025, and April 2nd, 2025. The names of these files are "PACE_OCI.20250330.L3m.DAY.CLOUD.V3_0.1deg.NRT.nc" and "PACE_OCI.20250402.L3m.DAY.CLOUD.V3_0.1deg.NRT.nc", respectively.

### References:
Hansen, J.E., Travis, L.D. Light scattering in planetary atmospheres. Space Sci Rev 16, 527–610 (1974). https://doi.org/10.1007/BF00168069

Heymsfield, A. J., et al. Cirrus Clouds. Meteor. Monogr. 58, 2.1–2.26 (2017). https://doi.org/10.1175/AMSMONOGRAPHS-D-16-0010.1 

Ocean Color Instrument. Accessed 05/01/2025. https://pace.oceansciences.org/oci.htm
